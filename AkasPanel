-- =====================================================
-- Akas Cheat Panel
-- =====================================================

-- Game Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local StarterGui = game:GetService("StarterGui")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CoreGui = game:GetService("CoreGui")
local Lighting = game:GetService("Lighting")

-- Drawing library (for FOV circle)
local Drawing = nil
if pcall(function() return Drawing end) and type(Drawing) == "table" then
    Drawing = Drawing
else
    Drawing = nil
    warn("Drawing library not available")
end

-- Global Variables
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera
local MenuFrame = nil
local FloatingButton = nil
local CurrentTarget = nil
local PlayerHighlights = {}
local FOVCircle = nil

-- Configuration Table (Default Values)
local Config = {
    Mode = 1, -- 1 = Silent Aim, 2 = Aimlock
    FOVEnabled = false,
    FOVSize = 80,
    AimEnabled = false,
    ESPEnabled = false,
    TeamCheck = false,
    ESPColor = Color3.fromRGB(255, 50, 50), -- Red
    ESPTeamColor = Color3.fromRGB(50, 150, 250) -- Blue
}

-- =====================================================
-- UTILITY FUNCTIONS
-- =====================================================

function IsSameTeamESP(player)
    if not player or not LocalPlayer then return false end
    
    -- Check if players are on the same team
    local localTeam = LocalPlayer.Team
    local playerTeam = player.Team
    
    if localTeam and playerTeam then
        return localTeam == playerTeam
    end
    
    local localGroupId = LocalPlayer:GetAttribute("GroupId") or 0
    local playerGroupId = player:GetAttribute("GroupId") or 0
    
    return localGroupId == playerGroupId and localGroupId ~= 0
end

function ToggleESP(enabled)
    Config.ESPEnabled = enabled
    
    if enabled then
        print("[ESP] Enabled")
        -- Create highlights for existing players
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player.Character then
                CreatePlayerHighlight(player)
            end
        end
    else
        print("[ESP] Disabled")
        -- Remove all highlights
        for player, highlight in pairs(PlayerHighlights) do
            if highlight then
                highlight:Destroy()
                PlayerHighlights[player] = nil
            end
        end
    end
end

function CreatePlayerHighlight(player)
    if not player or player == LocalPlayer then return end
    if PlayerHighlights[player] then return end
    
    local character = player.Character
    if not character then return end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end
    
    -- Create Highlight object
    local highlight = Instance.new("Highlight")
    highlight.Name = "AKASESP_" .. player.Name
    highlight.Adornee = character
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    
    -- Set colors based on team check
    if Config.TeamCheck and IsSameTeamESP(player) then
        highlight.FillColor = Config.ESPTeamColor
        highlight.OutlineColor = Config.ESPTeamColor
    else
        highlight.FillColor = Config.ESPColor
        highlight.OutlineColor = Config.ESPColor
    end
    
    highlight.FillTransparency = 0.3
    highlight.OutlineTransparency = 0
    
    -- Parent highlight to player's character
    highlight.Parent = character
    PlayerHighlights[player] = highlight
end

function RemovePlayerHighlight(player)
    if PlayerHighlights[player] then
        PlayerHighlights[player]:Destroy()
        PlayerHighlights[player] = nil
    end
end

function UpdatePlayerHighlight(player)
    local highlight = PlayerHighlights[player]
    if not highlight then return end
    
    if not player.Character or not player.Character.Parent then
        RemovePlayerHighlight(player)
        return
    end
    
    highlight.Adornee = player.Character
    
    -- Update colors if team status changed
    if Config.TeamCheck and IsSameTeamESP(player) then
        if highlight.FillColor ~= Config.ESPTeamColor then
            highlight.FillColor = Config.ESPTeamColor
            highlight.OutlineColor = Config.ESPTeamColor
        end
    else
        if highlight.FillColor ~= Config.ESPColor then
            highlight.FillColor = Config.ESPColor
            highlight.OutlineColor = Config.ESPColor
        end
    end
end

function CreateFOVCircle()
    if not Drawing then return end
    if FOVCircle then FOVCircle:Remove() end
    
    FOVCircle = Drawing.new("Circle")
    FOVCircle.Visible = Config.FOVEnabled
    FOVCircle.Radius = Config.FOVSize
    FOVCircle.Color = Color3.fromRGB(255, 255, 255)
    FOVCircle.Thickness = 2
    FOVCircle.Filled = false
    FOVCircle.Transparency = 1
    
    UpdateFOVCircle()
end

function UpdateFOVCircle()
    if not Drawing or not FOVCircle then return end
    
    FOVCircle.Visible = Config.FOVEnabled
    FOVCircle.Radius = Config.FOVSize
    
    if Camera then
        FOVCircle.Position = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
    end
end

function IsValidDaHoodPlayer(player)
    if not player then return false end
    if player == LocalPlayer then return false end
    if not player.Character then return false end
    
    local character = player.Character
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid or humanoid.Health <= 0 then return false end
    
    local torso = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("Torso")
    if not torso then return false end
    
    -- Team check for aimlock
    if Config.TeamCheck and IsSameTeamESP(player) then
        return false
    end
    
    -- Check if player is visible
    if Camera then
        local torsoPosition = torso.Position
        local screenPoint, onScreen = Camera:WorldToViewportPoint(torsoPosition)
        return onScreen
    end
    
    return true
end

function GetClosestTorsoPlayer()
    local closestPlayer = nil
    local closestDistance = math.huge
    
    for _, player in pairs(Players:GetPlayers()) do
        if IsValidDaHoodPlayer(player) then
            local character = player.Character
            local torso = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("Torso")
            
            if torso then
                local distance = (torso.Position - Camera.CFrame.Position).Magnitude
                if distance < closestDistance then
                    closestDistance = distance
                    closestPlayer = player
                end
            end
        end
    end
    
    return closestPlayer
end

function AimAtTorso()
    if not CurrentTarget or not CurrentTarget.Character then return end
    
    local character = CurrentTarget.Character
    local torso = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("Torso")
    if not torso then return end
    
    local mouse = LocalPlayer:GetMouse()
    if mouse and mouse.Target then
        -- Calculate aim position
        local aimPosition = torso.Position
        
        -- Set mouse position to target position
        local screenPoint, onScreen = Camera:WorldToScreenPoint(aimPosition)
        if onScreen then
            -- Simulate mouse movement (this may need adjustment for your game)
            mousemoverel(screenPoint.X - mouse.X, screenPoint.Y - mouse.Y)
        end
    end
end

-- =====================================================
-- MENU CREATION FUNCTIONS
-- =====================================================

function CreateMenu()
    -- Main Menu Frame
    local menuFrame = Instance.new("Frame")
    menuFrame.Name = "AkasCheatMenu"
    menuFrame.Size = UDim2.new(0, 350, 0, 400)
    menuFrame.Position = UDim2.new(0.5, -175, 0.5, -200)
    menuFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    menuFrame.BackgroundTransparency = 0.2
    menuFrame.BorderSizePixel = 0
    menuFrame.Visible = false
    
    local menuCorner = Instance.new("UICorner")
    menuCorner.CornerRadius = UDim.new(0, 12)
    menuCorner.Parent = menuFrame
    
    -- Title Bar
    local titleBar = Instance.new("Frame")
    titleBar.Size = UDim2.new(1, 0, 0, 40)
    titleBar.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
    titleBar.Parent = menuFrame
    
    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0, 12)
    titleCorner.Parent = titleBar
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Text = "AKAS CHEAT MENU"
    titleLabel.Size = UDim2.new(1, 0, 1, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextSize = 18
    titleLabel.Parent = titleBar
    
    -- Close Button
    local closeButton = Instance.new("TextButton")
    closeButton.Text = "X"
    closeButton.Size = UDim2.new(0, 30, 0, 30)
    closeButton.Position = UDim2.new(1, -35, 0, 5)
    closeButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    closeButton.TextColor3 = Color3.white
    closeButton.Font = Enum.Font.GothamBold
    closeButton.TextSize = 14
    closeButton.Parent = titleBar
    
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 6)
    closeCorner.Parent = closeButton
    
    closeButton.MouseButton1Click:Connect(function()
        menuFrame.Visible = false
    end)
    
    -- Menu Content Frame
    local contentFrame = Instance.new("Frame")
    contentFrame.Size = UDim2.new(1, -20, 1, -60)
    contentFrame.Position = UDim2.new(0, 10, 0, 50)
    contentFrame.BackgroundTransparency = 1
    contentFrame.Parent = menuFrame
    
    -- Parent menu to CoreGui
    menuFrame.Parent = CoreGui or LocalPlayer:WaitForChild("PlayerGui")
    
    -- Store reference to use in other functions
    MenuFrame = contentFrame
    
    -- Create sections
    CreateMainToggles()
    CreateESPSection()
    
    return menuFrame
end

-- =====================================================
-- FLOATING BUTTON CREATION
-- =====================================================

function CreateFloatingButton()
    local button = Instance.new("TextButton")
    button.Name = "AkasCheat"
    button.Text = "≡"
    button.Size = UDim2.new(0, 50, 0, 50)
    button.Position = UDim2.new(1, -60, 0.5, -25)
    button.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    button.TextColor3 = Color3.white
    button.Font = Enum.Font.GothamBold
    button.TextSize = 24
    button.ZIndex = 1000
    
    local buttonCorner = Instance.new("UICorner")
    buttonCorner.CornerRadius = UDim.new(0, 25)
    buttonCorner.Parent = button
    
    button.Parent = CoreGui or LocalPlayer:WaitForChild("PlayerGui")
    FloatingButton = button
    
    return button
end

-- =====================================================
-- YOUR EXISTING MENU FUNCTIONS (With service fixes)
-- =====================================================

function CreateESPSection()
    -- ESP SECTION
    local espFrame = Instance.new("Frame")
    espFrame.Name = "ESP_Section"
    espFrame.Size = UDim2.new(0.9, 0, 0, 60)
    espFrame.Position = UDim2.new(0.05, 0, 0.5, 0)
    espFrame.BackgroundColor3 = Color3.fromRGB(50, 30, 30)
    espFrame.BackgroundTransparency = 0.2
    espFrame.Parent = MenuFrame
    
    local espCorner = Instance.new("UICorner")
    espCorner.CornerRadius = UDim.new(0, 8)
    espCorner.Parent = espFrame
    
    -- ESP Title
    local espTitle = Instance.new("TextLabel")
    espTitle.Text = "ESP HIGHLIGHT"
    espTitle.Size = UDim2.new(1, 0, 0, 20)
    espTitle.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
    espTitle.TextColor3 = Color3.white
    espTitle.Font = Enum.Font.GothamBold
    espTitle.TextSize = 12
    espTitle.Parent = espFrame
    
    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0, 8)
    titleCorner.Parent = espTitle
    
    -- ESP ON/OFF Button
    local espToggleBtn = Instance.new("TextButton")
    espToggleBtn.Name = "ESPToggle"
    espToggleBtn.Text = "ESP: OFF"
    espToggleBtn.Size = UDim2.new(0.45, 0, 0.55, 0)
    espToggleBtn.Position = UDim2.new(0.05, 0, 0.35, 0)
    espToggleBtn.Font = Enum.Font.GothamBold
    espToggleBtn.TextSize = 12
    espToggleBtn.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
    espToggleBtn.TextColor3 = Color3.white
    espToggleBtn.Parent = espFrame
    
    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(0, 6)
    toggleCorner.Parent = espToggleBtn
    
    -- Team Check Toggle
    local teamToggleBtn = Instance.new("TextButton")
    teamToggleBtn.Name = "TeamToggle"
    teamToggleBtn.Text = "TEAM"
    teamToggleBtn.Size = UDim2.new(0.20, 0, 0.55, 0)
    teamToggleBtn.Position = UDim2.new(0.55, 0, 0.35, 0)
    teamToggleBtn.Font = Enum.Font.Gotham
    teamToggleBtn.TextSize = 11
    teamToggleBtn.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
    teamToggleBtn.TextColor3 = Color3.white
    teamToggleBtn.Parent = espFrame
    
    local teamCorner = Instance.new("UICorner")
    teamCorner.CornerRadius = UDim.new(0, 6)
    teamCorner.Parent = teamToggleBtn
    
    -- FOV Adjust
    local fovAdjustBtn = Instance.new("TextButton")
    fovAdjustBtn.Name = "FOVAdjust"
    fovAdjustBtn.Text = "FOV " .. Config.FOVSize
    fovAdjustBtn.Size = UDim2.new(0.20, 0, 0.55, 0)
    fovAdjustBtn.Position = UDim2.new(0.80, 0, 0.35, 0)
    fovAdjustBtn.Font = Enum.Font.Gotham
    fovAdjustBtn.TextSize = 11
    fovAdjustBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 90)
    fovAdjustBtn.TextColor3 = Color3.white
    fovAdjustBtn.Parent = espFrame
    fovAdjustBtn.Visible = Config.Mode == 1
    
    local fovCorner = Instance.new("UICorner")
    fovCorner.CornerRadius = UDim.new(0, 6)
    fovCorner.Parent = fovAdjustBtn
    
    -- ====== ESP TOGGLE CLICK HANDLER ======
    espToggleBtn.MouseButton1Click:Connect(function()
        Config.ESPEnabled = not Config.ESPEnabled
        ToggleESP(Config.ESPEnabled)
        
        -- Update button appearance
        if Config.ESPEnabled then
            espToggleBtn.Text = "ESP: ON"
            espToggleBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)  -- Red
            teamToggleBtn.Text = "TEAM"
        else
            espToggleBtn.Text = "ESP: OFF"
            espToggleBtn.BackgroundColor3 = Color3.fromRGB(80, 80, 80)   -- Grey
            teamToggleBtn.Text = "TEAM"
        end
    end)
    
    -- ====== TEAM TOGGLE CLICK HANDLER ======
    teamToggleBtn.MouseButton1Click:Connect(function()
        Config.TeamCheck = not Config.TeamCheck
        
        -- Update team check in ESP
                if Config.TeamCheck then
            teamToggleBtn.BackgroundColor3 = Color3.fromRGB(50, 150, 250)  -- Blue
            teamToggleBtn.Text = "TEAM ✓"
        else
            teamToggleBtn.BackgroundColor3 = Color3.fromRGB(80, 80, 80)    -- Grey
            teamToggleBtn.Text = "TEAM"
        end
        
        -- Update existing highlights
        if Config.ESPEnabled then
            for player, highlight in pairs(PlayerHighlights) do
                if highlight and highlight.Enabled then
                    if Config.TeamCheck and IsSameTeamESP(player) then
                        highlight.FillColor = Config.ESPTeamColor
                        highlight.OutlineColor = Config.ESPTeamColor
                    else
                        highlight.FillColor = Config.ESPColor
                        highlight.OutlineColor = Config.ESPColor
                    end
                end
            end
        end
        
        print("[ESP] Team check: " .. (Config.TeamCheck and "ENABLED" or "DISABLED"))
    end)
    
    -- ====== FOV ADJUST CLICK HANDLER ======
    fovAdjustBtn.MouseButton1Click:Connect(function()
        Config.FOVSize = Config.FOVSize + 20
        if Config.FOVSize > 200 then
            Config.FOVSize = 40
        end
        fovAdjustBtn.Text = "FOV " .. Config.FOVSize
        UpdateFOVCircle()
        print("[FOV] Size: " .. Config.FOVSize)
    end)
    
    spawn(function()
        wait(0.1)
        if Config.ESPEnabled then
            espToggleBtn.Text = "ESP: ON"
            espToggleBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
        else
            espToggleBtn.Text = "ESP: OFF"
            espToggleBtn.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
        end
        
        if Config.TeamCheck then
            teamToggleBtn.BackgroundColor3 = Color3.fromRGB(50, 150, 250)
            teamToggleBtn.Text = "TEAM ✓"
        else
            teamToggleBtn.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
            teamToggleBtn.Text = "TEAM"
        end
    end)
end

function UpdateMainToggle()
    local mainToggle = MenuFrame:FindFirstChild("MainToggle")
    if not mainToggle then return end
    
    if Config.Mode == 1 then
        -- SILENT AIM MODE
        if Config.FOVEnabled then
            mainToggle.Text = "SILENT: ON"
            mainToggle.BackgroundColor3 = Color3.fromRGB(50, 180, 100) -- Green
        else
            mainToggle.Text = "SILENT: OFF"
            mainToggle.BackgroundColor3 = Color3.fromRGB(180, 50, 50)  -- Red
        end
    else
        -- AIMLOCK MODE
        if Config.AimEnabled then
            mainToggle.Text = "AIMLOCK: ON"
            mainToggle.BackgroundColor3 = Color3.fromRGB(50, 120, 180) -- Blue
        else
            mainToggle.Text = "AIMLOCK: OFF"
            mainToggle.BackgroundColor3 = Color3.fromRGB(180, 50, 50)  -- Red
        end
    end
end

-- =====================================================
-- UPDATE MAIN TOGGLE FUNCTION
-- =====================================================

function ToggleMainFeature()
    if Config.Mode == 1 then
        -- SILENT AIM TOGGLE
        Config.FOVEnabled = not Config.FOVEnabled
        UpdateFOVCircle()
        
        if Config.FOVEnabled then
            print("[Silent Aim] FOV Circle Enabled")
        else
            print("[Silent Aim] FOV Circle Disabled")
        end
    else
        -- AIMLOCK TOGGLE
        Config.AimEnabled = not Config.AimEnabled
        
        if Config.AimEnabled then
            CurrentTarget = GetClosestTorsoPlayer()
            print("[AimLock] Activated")
            print("Target: " .. (CurrentTarget and CurrentTarget.Name or "None"))
        else
            CurrentTarget = nil
            print("[AimLock] Deactivated")
        end
    end
    
    UpdateMainToggle()
end

-- =====================================================
-- UPDATE CREATE MAINToggles FUNCTION
-- =====================================================

function CreateMainToggles()
    local toggleFrame = Instance.new("Frame")
    toggleFrame.Size = UDim2.new(0.9, 0, 0, 60)
    toggleFrame.Position = UDim2.new(0.05, 0, 0.33, 0)
    toggleFrame.BackgroundTransparency = 1
    toggleFrame.Parent = MenuFrame
    
    -- Main Toggle
    local mainToggle = Instance.new("TextButton")
    mainToggle.Name = "MainToggle"
    mainToggle.Size = UDim2.new(0.6, 0, 0.7, 0)
    mainToggle.Position = UDim2.new(0.2, 0, 0.15, 0)
    mainToggle.Font = Enum.Font.GothamBold
    mainToggle.TextSize = 13
    mainToggle.Parent = toggleFrame
    
    local mainCorner = Instance.new("UICorner")
    mainCorner.CornerRadius = UDim.new(0, 8)
    mainCorner.Parent = mainToggle
    
    -- Info label
    local infoLabel = Instance.new("TextLabel")
    infoLabel.Text = Config.Mode == 1 and "F8=Toggles Silent" or "F8=Toggles Aimlock"
    infoLabel.Size = UDim2.new(1, 0, 0, 15)
    infoLabel.Position = UDim2.new(0, 0, 0.8, 0)
    infoLabel.BackgroundTransparency = 1
    infoLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
    infoLabel.Font = Enum.Font.Gotham
    infoLabel.TextSize = 10
    infoLabel.Parent = toggleFrame
    
    -- HotKeys label
    local hotkeyLabel = Instance.new("TextLabel")
    hotkeyLabel.Text = "HOTKEYS: F8=Main  F9=ESP  F10=TEAM  LeftClick=Menu"
    hotkeyLabel.Size = UDim2.new(1, 0, 0, 15)
    hotkeyLabel.Position = UDim2.new(0, 0, 0.95, 0)
    hotkeyLabel.BackgroundTransparency = 1
    hotkeyLabel.TextColor3 = Color3.fromRGB(150, 150, 200)
    hotkeyLabel.Font = Enum.Font.Gotham
    hotkeyLabel.TextSize = 10
    hotkeyLabel.Parent = toggleFrame
    
    -- CLICK HANDLER
    mainToggle.MouseButton1Click:Connect(function()
        ToggleMainFeature()
    end)
    
    UpdateMainToggle()
end

-- =====================================================
-- HOTKEYS FOR ALL FEATURES
-- =====================================================

UserInputService.InputBegan:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.F8 then
        ToggleMainFeature()
    end
    
    -- HOTKEY F9: Toggle ESP
    if input.KeyCode == Enum.KeyCode.F9 then
        Config.ESPEnabled = not Config.ESPEnabled
        ToggleESP(Config.ESPEnabled)
        
        if MenuFrame and MenuFrame.Parent and MenuFrame.Parent.Visible then
            local espToggle = MenuFrame:FindFirstChild("ESPToggle", true)
            if espToggle then
                if Config.ESPEnabled then
                    espToggle.Text = "ESP: ON"
                    espToggle.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
                else
                    espToggle.Text = "ESP: OFF"
                    espToggle.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
                end
            end
        end
        
        print("[HOTKEY] ESP: " .. (Config.ESPEnabled and "ON" or "OFF"))
    end
    
    -- HOTKEY F10: Toggle Team Check
    if input.KeyCode == Enum.KeyCode.F10 then
        Config.TeamCheck = not Config.TeamCheck
        
        if MenuFrame and MenuFrame.Parent and MenuFrame.Parent.Visible then
            local teamToggle = MenuFrame:FindFirstChild("TeamToggle", true)
            if teamToggle then
                if Config.TeamCheck then
                    teamToggle.BackgroundColor3 = Color3.fromRGB(50, 150, 250)
                    teamToggle.Text = "TEAM ✓"
                else
                    teamToggle.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
                    teamToggle.Text = "TEAM"
                end
            end
        end
        
        print("[HOTKEY] Team Check: " .. (Config.TeamCheck and "ON" or "OFF"))
    end
    
    -- MENU TOGGLE with LeftClick on Floating Button
    if input.UserInputType == Enum.UserInputType.MouseButton1 and FloatingButton then
        if MenuFrame then
            local menuParent = MenuFrame.Parent
            if menuParent then
                MenuFrame.Visible = not MenuFrame.Visible
                print("[MENU] " .. (MenuFrame.Visible and "Opened" or "Closed"))
            end
        end
    end
end)

-- =====================================================
-- PLAYER CONNECTION HANDLERS
-- =====================================================

-- Handle player connections
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        wait(0.5)
        if Config.ESPEnabled then
            CreatePlayerHighlight(player)
        end
    end)
    
    player.CharacterRemoving:Connect(function()
        RemovePlayerHighlight(player)
    end)
    
    if player.Character and Config.ESPEnabled then
        CreatePlayerHighlight(player)
    end
end)

Players.PlayerRemoving:Connect(function(player)
    RemovePlayerHighlight(player)
end)

-- =====================================================
-- INITIALIZATION
-- =====================================================

function InitializeAllFeatures()
    -- Create FOV Circle if Drawing library is available
    if Drawing then
        CreateFOVCircle()
    else
        warn("Drawing library not available - FOV circle disabled")
    end
    
    -- Initialize highlights for existing players
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            player.CharacterAdded:Connect(function()
                wait(0.5)
                if Config.ESPEnabled then
                    CreatePlayerHighlight(player)
                end
            end)
            
            player.CharacterRemoving:Connect(function()
                RemovePlayerHighlight(player)
            end)
            
            if player.Character and Config.ESPEnabled then
                CreatePlayerHighlight(player)
            end
        end
    end
    
    -- Create floating menu button
    CreateFloatingButton()
    
    -- Create main menu
    local mainMenu = CreateMenu()
    
    -- Main update loop
    RunService.RenderStepped:Connect(function()
        -- Update FOV circle position
        if Config.FOVEnabled and FOVCircle then
            UpdateFOVCircle()
        end
        
        -- Aimlock update
        if Config.AimEnabled and CurrentTarget then
            AimAtTorso()
        end
        
        -- Auto-find new target if current is invalid
        if Config.Mode == 2 and Config.AimEnabled then
            if not CurrentTarget or not IsValidDaHoodPlayer(CurrentTarget) then
                CurrentTarget = GetClosestTorsoPlayer()
            end
        end
        
        -- ESP update
        if Config.ESPEnabled then
            for player, highlight in pairs(PlayerHighlights) do
                if player and player.Parent then
                    UpdatePlayerHighlight(player)
                else
                    RemovePlayerHighlight(player)
                end
            end
        end
    end)
    
    -- Connect floating button menu toggle
    if FloatingButton and FloatingButton.Parent then
        FloatingButton.MouseButton1Click:Connect(function()
            if MenuFrame then
                local menuParent = MenuFrame.Parent
                if menuParent then
                    MenuFrame.Visible = not MenuFrame.Visible
                end
            end
        end)
    else
        warn("FloatingButton not found - cannot connect menu toggle")
    end
    
    -- ===========================================
    -- FIX: ADD MISSING mousemoverel FUNCTION
    -- ===========================================
    if not mousemoverel then
        function mousemoverel(x, y)
            -- Simulate mouse movement (basic implementation)
            local mouse = LocalPlayer:GetMouse()
            if mouse then
                -- This is a simplified version, may need adjustment for your game
                mouse.Move:Fire(x, y)
            end
        end
        print("[FIX] Added mousemoverel function")
    end
    
    print("===========================================")
    print("DAHOOD AIM SUITE LOADED SUCCESSFULLY")
    print("===========================================")
    print("FEATURES:")
    print("1. SILENT AIM (Mode 1) - F8 to toggle")
    print("2. AIMLOCK (Mode 2) - F8 to toggle")
    print("3. ESP HIGHLIGHT (Red) - F9 to toggle")
    print("4. TEAM CHECK - F10 to toggle")
    print("")
    print("MENU: Click Floating Button to open/close")
    print("HOTKEYS: F8 (Main), F9 (ESP), F10 (Team)")
    print("===========================================")
end

-- =====================================================
-- DELAYED INITIALIZATION
-- =====================================================

task.wait(3)
print("[AKAS] Initializing features...")
InitializeAllFeatures()
